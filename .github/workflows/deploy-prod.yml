name: Deploy to Production

on:
  push:
    branches:
      - prod # Trigger on pushes to the prod branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY_PROD }}

      - name: Add production server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST_PROD }} >> ~/.ssh/known_hosts

      - name: Deploy to Production VM
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER_PROD }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST_PROD }}
          DATABASE_URL: ${{ secrets.DATABASE_URL_PROD }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET_PROD }}
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL_PROD }}
        run: |
          ssh -A -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST <<'EOF'
            set -e
            
            DEPLOY_DIR="/home/$DEPLOY_USER/vets-prod"
            REPO_URL="git@github.com:${{ github.repository }}.git"
            
            echo "=== Starting Production Deployment ==="
            
            # Ensure deploy directory exists and navigate to it
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"
            
            # Clone or update repository
            if [ ! -d .git ]; then
              echo "üì¶ Cloning repository..."
              git clone "$REPO_URL" .
            else
              echo "üîÑ Updating repository..."
              git fetch origin
              
              # CRITICAL: Backup data BEFORE git reset to prevent data loss
              echo "üíæ Creating pre-deployment backup..."
              BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
              mkdir -p temp_backup
              
              # Now safe to reset git
              git reset --hard origin/prod
              git clean -fd
              
              # Clean up temp backup
              rm -rf temp_backup
            fi

            # Run production setup (force update)
            echo "üîß Setting up production environment..."
            
            # Setup PostgreSQL database (first time)
            if [ ! -f .production_setup_done ]; then
              echo "üìä PostgreSQL database setup skipped (manual setup required)..."
              # Please ensure the database 'vets_prod' and user 'vets_prod' exist.
              # See server setup instructions.
            fi
            
            # Install Node.js dependencies
            npm install
            npm --prefix apps/web install
            
            # Install Go dependencies
            cd apps/api
            go mod download
            cd ..
            
            touch .production_setup_done

            # Update environment files with secrets
            echo "üîê Configuring production environment variables..."
            
            # API environment for production
            echo "API_HTTP_ADDR=:8080" > apps/api/.env.production
            echo "DATABASE_URL=$DATABASE_URL" >> apps/api/.env.production
            echo "AUTH_SECRET=$AUTH_SECRET" >> apps/api/.env.production
            echo "API_ALLOWED_ORIGINS=https://synergyvets.com,https://www.synergyvets.com,http://synergyvets.com,http://www.synergyvets.com" >> apps/api/.env.production
            echo "API_SHUTDOWN_TIMEOUT=10s" >> apps/api/.env.production
            echo "LOG_LEVEL=info" >> apps/api/.env.production
            echo "LOG_PRETTY=false" >> apps/api/.env.production
            echo "AUTH_ACCESS_TOKEN_TTL=15m" >> apps/api/.env.production
            echo "AUTH_REFRESH_TOKEN_TTL=720h" >> apps/api/.env.production

            # Frontend environment for production
            echo "NEXT_PUBLIC_API_BASE_URL=$NEXT_PUBLIC_API_BASE_URL" > apps/web/.env.production

            # Build and deploy backend
            echo "üöÄ Building and deploying production backend..."
            cd apps/api
            CGO_ENABLED=0 GOOS=linux go build -ldflags="-w -s" -o bin/api ./cmd/api
            
            # Stop existing PM2 process if running
            pm2 delete vets-api-prod 2>/dev/null || true
            
            # Start API with PM2
            pm2 start bin/api --name vets-api-prod --env production
            cd ../..

            # Build and deploy frontend
            echo "üé® Building and deploying production frontend..."
            cd apps/web
            npm run build
            
            # Stop existing PM2 process if running
            pm2 delete vets-web-prod 2>/dev/null || true
            
            # Start Next.js with PM2
            pm2 start npm --name vets-web-prod -- start -- -p 3001
            cd ../..

            # Save PM2 configuration
            pm2 save

            echo "=== Production Deployment Status ==="
            pm2 status
            echo ""
            echo "‚úÖ Production deployment completed successfully!"
            echo "üåê Frontend: Running on port 3001"
            echo "üîß Backend API: Running on port 8080"
            echo "üìÅ Configure nginx to proxy production domains to these ports"
            echo "üåç Production ready for: synergyvets.com, www.synergyvets.com"
          EOF
