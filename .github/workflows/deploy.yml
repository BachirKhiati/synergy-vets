name: Deploy to Development

on:
  push:
    branches:
      - main # Trigger on pushes to the main branch (dev environment for now)

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH agent
        uses: webfactory/ssh-agent@v0.5.4
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add dev server to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to Development VM
        env:
          DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
          NEXT_PUBLIC_API_BASE_URL: ${{ secrets.NEXT_PUBLIC_API_BASE_URL }}
        run: |
          ssh -A -o StrictHostKeyChecking=no $DEPLOY_USER@$DEPLOY_HOST <<'EOF'
            set -e
            
            DEPLOY_DIR="/home/$DEPLOY_USER/vets-dev"
            REPO_URL="git@github.com:${{ github.repository }}.git"
            
            echo "=== Starting Development Deployment ==="
            
            # Ensure deploy directory exists and navigate to it
            mkdir -p "$DEPLOY_DIR"
            cd "$DEPLOY_DIR"
            
            # Clone or update repository
            if [ ! -d .git ]; then
              echo "üì¶ Cloning repository..."
              git clone "$REPO_URL" .
            else
              echo "üîÑ Updating repository..."
              git fetch origin
              
              # CRITICAL: Backup data BEFORE git reset to prevent data loss
              echo "üíæ Creating pre-deployment backup..."
              BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
              mkdir -p temp_backup
              
              # Now safe to reset git
              git reset --hard origin/main
              git clean -fd
              
              # Clean up temp backup
              rm -rf temp_backup
            fi

            # Run development setup (first time only)
            if [ ! -f .dev_setup_done ]; then
              echo "üîß Setting up development environment..."
              
              # Setup PostgreSQL database
              echo "üìä Setting up PostgreSQL database..."
              sudo -u postgres psql <<PGSQL
              SELECT 'CREATE DATABASE vets_dev' WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = 'vets_dev')\gexec
              DO \$\$
              BEGIN
                IF NOT EXISTS (SELECT FROM pg_user WHERE usename = 'vets_dev') THEN
                  CREATE USER vets_dev WITH PASSWORD '$DATABASE_URL';
                END IF;
              END
              \$\$;
              GRANT ALL PRIVILEGES ON DATABASE vets_dev TO vets_dev;
PGSQL
              
              # Install Node.js dependencies
              npm install
              npm --prefix apps/web install
              
              # Install Go dependencies
              cd apps/api
              go mod download
              cd ..
              
              touch .dev_setup_done
            fi

            # Update environment files with secrets
            echo "üîê Configuring development environment variables..."
            
            # API environment for dev
            echo "API_HTTP_ADDR=:8081" > apps/api/.env.production
            echo "DATABASE_URL=$DATABASE_URL" >> apps/api/.env.production
            echo "AUTH_SECRET=$AUTH_SECRET" >> apps/api/.env.production
            echo "API_ALLOWED_ORIGINS=https://vets-dev.example.com,http://localhost:3002" >> apps/api/.env.production
            echo "API_SHUTDOWN_TIMEOUT=10s" >> apps/api/.env.production
            echo "LOG_LEVEL=info" >> apps/api/.env.production
            echo "LOG_PRETTY=false" >> apps/api/.env.production
            echo "AUTH_ACCESS_TOKEN_TTL=15m" >> apps/api/.env.production
            echo "AUTH_REFRESH_TOKEN_TTL=720h" >> apps/api/.env.production

            # Frontend environment for dev
            echo "NEXT_PUBLIC_API_BASE_URL=$NEXT_PUBLIC_API_BASE_URL" > apps/web/.env.production

            # Build and deploy backend
            echo "üöÄ Building and deploying development backend..."
            cd apps/api
            CGO_ENABLED=0 GOOS=linux go build -ldflags="-w -s" -o bin/api ./cmd/api
            
            # Stop existing PM2 process if running
            pm2 delete vets-api-dev 2>/dev/null || true
            
            # Start API with PM2
            pm2 start bin/api --name vets-api-dev --env production
            cd ../..

            # Build and deploy frontend
            echo "üé® Building and deploying development frontend..."
            cd apps/web
            npm run build
            
            # Stop existing PM2 process if running
            pm2 delete vets-web-dev 2>/dev/null || true
            
            # Start Next.js with PM2
            pm2 start npm --name vets-web-dev -- start -- -p 3002
            cd ../..

            # Save PM2 configuration
            pm2 save

            echo "=== Development Deployment Status ==="
            pm2 status
            echo ""
            echo "‚úÖ Development deployment completed successfully!"
            echo "üåê Frontend: Running on port 3002"
            echo "üîß Backend API: Running on port 8081"
            echo "üìÅ Configure nginx to proxy your dev domain to these ports"
          EOF
